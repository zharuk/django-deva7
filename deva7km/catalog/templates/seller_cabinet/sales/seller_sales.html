{% extends 'seller_cabinet/base.html' %}

{% block title %}Продажи{% endblock %}

{% block content %}
    <h1>Продажи</h1>
    <div class="alert alert-danger" id="error-alert"></div>
    <div class="alert alert-success" id="success-alert"></div>

    <div class="search-container">
        <input type="text" id="search-article" class="form-control" placeholder="Введите артикул">
        <span id="clear-search" class="clear-search">&times;</span>
    </div>

    <div id="available-items" class="my-4 search-results">
        <!-- Список доступных товаров будет загружаться сюда через AJAX -->
    </div>

    <div id="selected-items" class="my-5">
        <h2>Выбранные товары</h2>
        <div class="table-responsive">
            <table id="selected-items-table" class="table table-dark table-striped">
                <thead>
                    <tr>
                        <th>Арт.</th>
                        <th>Кол-во</th>
                        <th>Сумма</th>
                        <th>Удалить</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Выбранные товары будут отображаться здесь -->
                </tbody>
            </table>
        </div>
        <p class="text-right font-weight-bold">Итоговая сумма: <span id="total-amount">0</span> грн</p>
        <button id="clear-order" class="btn btn-danger btn-block">Очистить заказ</button>
        <button id="sell-button" class="btn btn-success btn-block">Продать</button>
    </div>

    <div id="daily-sales" class="my-5">
        <h2>Ежедневные продажи</h2>
        {% include 'seller_cabinet/sales/partials/daily_sales_items.html' %}
    </div>
{% endblock %}

{% block scripts %}
    <script>
        $(document).ready(function() {
            let debounceTimer;
            let currentPage = 1;
            let currentQuery = '';

            $('#search-article').on('input', function() {
                clearTimeout(debounceTimer);
                const query = $(this).val();
                currentQuery = query;
                currentPage = 1;
                if (query.length > 0) {
                    $('#clear-search').show();
                } else {
                    $('#clear-search').hide();
                }
                debounceTimer = setTimeout(function() {
                    if (query.length >= 3) {
                        loadSearchResults(query, currentPage);
                    } else {
                        $('#available-items').empty();
                    }
                }, 300);
            });

            $('#clear-search').click(function() {
                $('#search-article').val('');
                $('#clear-search').hide();
                $('#available-items').empty();
            });

            function showAlert(type, message) {
                const alertDiv = type === 'success' ? $('#success-alert') : $('#error-alert');
                alertDiv.text(message).slideDown();
                setTimeout(function() {
                    alertDiv.slideUp();
                }, 1000);
            }

            $(document).on('click', '.add-item-button', function() {
                const itemId = $(this).data('item-id');
                $.ajax({
                    url: '{% url "add_item_to_sale" %}',
                    method: 'POST',
                    data: {
                        'item_id': itemId,
                        'quantity': 1,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(data) {
                        if (data.error) {
                            showAlert('error', data.error);
                        } else {
                            $('#selected-items-table tbody').html(data.items_html);
                            $('#total-amount').text(data.total_amount);
                            showAlert('success', 'Товар успешно добавлен');
                            let itemRow = $('#available-items .item[data-item-id="' + itemId + '"]');
                            let currentQuantity = parseInt(itemRow.data('quantity'));
                            if (currentQuantity > 1) {
                                let newQuantity = currentQuantity - 1;
                                itemRow.data('quantity', newQuantity);
                                itemRow.find('.quantity').text(`(${newQuantity} в наличии)`);
                            } else {
                                itemRow.remove();
                            }
                            updateDailySales();
                        }
                    },
                    error: function(xhr) {
                        showAlert('error', xhr.responseJSON.error);
                    }
                });
            });

            $(document).on('click', '.remove-item-button', function() {
                const itemId = $(this).data('item-id');
                const productId = $(this).data('product-id');
                $.ajax({
                    url: '{% url "remove_item_from_sale" %}',
                    method: 'POST',
                    data: {
                        'item_id': itemId,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(data) {
                        $('#selected-items-table tbody').html(data.items_html);
                        $('#total-amount').text(data.total_amount);
                        showAlert('success', 'Товар успешно удален');
                        let itemRow = $('#available-items .item[data-item-id="' + productId + '"]');
                        if (itemRow.length) {
                            let currentQuantity = parseInt(itemRow.data('quantity'));
                            let newQuantity = currentQuantity + 1;
                            itemRow.data('quantity', newQuantity);
                            itemRow.find('.quantity').text(`(${newQuantity} в наличии)`);
                        } else {
                            loadSearchResults(currentQuery, currentPage);
                        }
                    },
                    error: function(xhr) {
                        showAlert('error', xhr.responseJSON.error);
                    }
                });
            });

            $('#clear-order').click(function() {
                $.ajax({
                    url: '{% url "clear_sale" %}',
                    method: 'POST',
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(data) {
                        $('#selected-items-table tbody').empty();
                        $('#total-amount').text('0');
                        showAlert('success', 'Заказ успешно очищен');
                    },
                    error: function(xhr) {
                        showAlert('error', xhr.responseJSON.error);
                    }
                });
            });

            $('#sell-button').click(function() {
                $.ajax({
                    url: '{% url "confirm_sale" %}',
                    method: 'POST',
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(data) {
                        $('#selected-items-table tbody').empty();
                        $('#total-amount').text('0');
                        showAlert('success', 'Продажа успешно завершена!');
                        updateDailySales();
                    },
                    error: function(xhr) {
                        showAlert('error', xhr.responseJSON.error);
                    }
                });
            });

            {% if pending_sale %}
            $.ajax({
                url: '{% url "get_pending_sale_items" %}',
                method: 'GET',
                data: {
                    'sale_id': '{{ pending_sale.id }}'
                },
                success: function(data) {
                    $('#selected-items-table tbody').html(data.items_html);
                    $('#total-amount').text(data.total_amount);
                },
                error: function(xhr) {
                    showAlert('error', xhr.responseJSON.error);
                }
            });
            {% endif %}

            function updateDailySales() {
                $.ajax({
                    url: '{% url "get_daily_sales" %}',
                    method: 'GET',
                    success: function(data) {
                        $('#daily-sales').html(data.sales_html);
                    },
                    error: function(xhr) {
                        showAlert('error', xhr.responseJSON.error);
                    }
                });
            }

            setInterval(updateDailySales, 30000);

            $(document).on('click', '#load-more-results', function() {
                currentPage = $(this).data('next-page');
                loadSearchResults(currentQuery, currentPage, true);
            });

            function loadSearchResults(query, page, append = false) {
                $.ajax({
                    url: '{% url "search_article" %}',
                    method: 'GET',
                    data: {
                        'article': query,
                        'page': page
                    },
                    success: function(data) {
                        if (append) {
                            $('.more-results').remove();
                            $('#available-items').append(data);
                        } else {
                            $('#available-items').html(data);
                        }
                        $('.search-results .search-item:last-child').removeClass('search-item:last-child');
                    },
                    error: function(xhr) {
                        showAlert('error', xhr.responseJSON.error);
                    }
                });
            }
        });
    </script>
{% endblock %}
